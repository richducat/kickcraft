<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>KickCraft — FC Street</title>

    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;800&family=Teko:wght@500&display=swap');

      body {
        margin: 0;
        overflow: hidden;
        background: #0f172a;
        user-select: none;
        -webkit-touch-callout: none;
        font-family: 'Montserrat', sans-serif;
        touch-action: none;
      }

      .ui-screen {
        position: absolute;
        inset: 0;
        display: none;
        z-index: 50;
      }

      #game-container {
        position: absolute;
        inset: 0;
        z-index: 1;
        background: #1a1a2e;
        visibility: hidden;
      }

      #scoreboard {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0;
        background: rgba(20, 20, 30, 0.95);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        pointer-events: auto;
      }

      .score-box {
        padding: 5px 25px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 60px;
      }

      .score-val {
        font-family: 'Teko', sans-serif;
        font-size: 2.5rem;
        color: #fff;
        line-height: 0.9;
      }

      .team-lbl {
        font-size: 0.7rem;
        color: #aaa;
        font-weight: 800;
        letter-spacing: 1px;
      }

      .timer-box {
        background: rgba(255, 255, 255, 0.05);
        padding: 0 15px;
        display: flex;
        align-items: center;
        color: #fff;
        font-weight: 700;
        font-family: 'Teko';
        font-size: 1.8rem;
      }

      #pause-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
        pointer-events: auto;
        cursor: pointer;
        backdrop-filter: blur(5px);
        z-index: 100;
      }

      #pause-btn:active {
        transform: scale(0.95);
        background: rgba(255, 255, 255, 0.2);
      }

      #controls-ui {
        position: absolute;
        inset: 0;
        pointer-events: auto;
        z-index: 20;
        display: none;
      }

      #joy-zone {
        position: absolute;
        bottom: 40px;
        left: 40px;
        width: 140px;
        height: 140px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.2);
        touch-action: none;
      }

      #joy-stick {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 50px;
        height: 50px;
        background: #fff;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        pointer-events: none;
      }

      .btn-grid {
        position: absolute;
        bottom: 40px;
        right: 40px;
        display: grid;
        gap: 20px;
        grid-template-areas:
          '. sprint'
          'pass shoot';
      }

      .btn {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: none;
        color: #fff;
        font-family: 'Teko';
        font-size: 1.5rem;
        backdrop-filter: blur(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        transition: transform 0.1s;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        touch-action: none;
      }

      .btn:active {
        transform: scale(0.9);
        filter: brightness(0.8);
      }

      #b-shoot {
        grid-area: shoot;
        background: linear-gradient(135deg, #ff2a6d, #ff5c8d);
        width: 95px;
        height: 95px;
        font-size: 1.8rem;
      }

      #b-pass {
        grid-area: pass;
        background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      }

      #b-sprint {
        grid-area: sprint;
        background: linear-gradient(135deg, #ffae00, #ff7b00);
        width: 65px;
        height: 65px;
        font-size: 1rem;
      }

      #key-hints {
        position: absolute;
        top: 10px;
        left: 10px;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.8rem;
        pointer-events: none;
        z-index: 25;
        display: none;
      }

      @media (min-width: 768px) {
        #key-hints {
          display: block;
        }
      }

      #pause-modal {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .pause-menu-btn {
        background: transparent;
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 15px 40px;
        margin: 10px;
        font-family: 'Teko';
        font-size: 2rem;
        width: 250px;
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
        clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
      }

      .pause-menu-btn:hover {
        background: #38bdf8;
        border-color: #38bdf8;
        color: black;
        transform: scale(1.05);
      }

      .pause-menu-btn.quit:hover {
        background: #ff2a6d;
        border-color: #ff2a6d;
      }

      .pitch-pattern {
        background-color: #1a4d2e;
        background-image: repeating-linear-gradient(
          90deg,
          transparent,
          transparent 50px,
          rgba(0, 0, 0, 0.1) 50px,
          rgba(0, 0, 0, 0.1) 100px
        );
      }
    </style>
  </head>

  <body>
    <!-- TITLE SCREEN -->
    <div id="title-screen" class="ui-screen bg-slate-950 flex flex-col items-center justify-center" style="display: flex">
      <div class="absolute inset-0 overflow-hidden opacity-30">
        <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-transparent to-transparent z-10"></div>
        <div
          class="w-full h-full bg-[url('https://images.unsplash.com/photo-1517466787929-bc90951d0974?q=80&w=2560&auto=format&fit=crop')] bg-cover bg-center"
        ></div>
      </div>
      <div class="z-20 flex flex-col items-center gap-6">
        <h1
          class="text-8xl md:text-9xl font-black text-white italic tracking-tighter drop-shadow-[0_0_25px_rgba(56,189,248,0.6)]"
          style="font-family: 'Teko'"
        >
          FC <span class="text-sky-400">STREET</span>
        </h1>
        <p class="text-slate-400 text-lg tracking-[0.5em] font-bold uppercase mb-8">KickCraft prototype</p>

        <div class="flex flex-col md:flex-row gap-4">
          <button
            onclick="startGame('match')"
            class="px-10 py-4 bg-white hover:bg-sky-400 hover:text-white transition-all text-black font-black text-xl uppercase tracking-widest"
            style="clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%)"
          >
            Match (3D)
          </button>
          <button
            onclick="startGame('runner')"
            class="px-10 py-4 bg-white/80 hover:bg-pink-500 hover:text-white transition-all text-black font-black text-xl uppercase tracking-widest"
            style="clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%)"
          >
            Street Run (WIP)
          </button>
        </div>
      </div>
      <div class="absolute bottom-6 text-slate-600 text-xs">v0 — stabilized shell</div>
    </div>

    <!-- SQUAD MENU -->
    <div id="squad-menu" class="ui-screen bg-slate-950 overflow-y-auto">
      <div class="min-h-screen flex flex-col items-center justify-center p-2 md:p-6">
        <div
          class="max-w-[1100px] w-full bg-slate-900 rounded-3xl shadow-2xl overflow-hidden border border-slate-800 flex flex-col h-full md:h-auto"
        >
          <div class="bg-gradient-to-r from-[#6CABDD] via-[#1C2C5B] to-[#1C2C5B] p-4 md:p-6 relative overflow-hidden shrink-0">
            <button onclick="goToTitle()" class="absolute top-4 right-4 text-white/50 hover:text-white font-bold text-xs uppercase z-50">
              Back
            </button>
            <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 md:w-20 md:h-20 bg-sky-200 rounded-full flex items-center justify-center border-4 border-white shadow-xl">
                  <svg class="text-[#1C2C5B] w-8 h-8 md:w-10 md:h-10 fill-current" viewBox="0 0 24 24">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                  </svg>
                </div>
                <div>
                  <h1 class="text-3xl md:text-5xl font-black text-white italic tracking-tighter uppercase drop-shadow-lg">
                    MAN CITY <span class="text-sky-300">25/26</span>
                  </h1>
                  <span
                    class="bg-white/20 px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-widest text-white border border-white/20"
                    >Starting XI</span
                  >
                </div>
              </div>
            </div>
          </div>

          <div class="relative w-full aspect-[4/5] md:aspect-[16/10] bg-slate-900 overflow-hidden group shrink-0" id="pitch-container"></div>

          <div class="bg-[#1C2C5B] p-4 border-t border-slate-700 shrink-0">
            <div class="flex flex-col items-center gap-4">
              <button
                onclick="beginMatch()"
                class="w-full md:w-auto bg-sky-500 hover:bg-sky-400 text-white font-black text-xl py-4 px-12 rounded-full shadow-[0_0_20px_rgba(56,189,248,0.5)] transition-all hover:scale-105 active:scale-95 uppercase tracking-widest border-2 border-white/20"
              >
                KICK OFF
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div id="game-container"></div>

    <div id="ui-layer" class="ui-screen">
      <div id="scoreboard">
        <div class="score-box" style="border-bottom: 3px solid #38bdf8">
          <div class="team-lbl">CITY</div>
          <div class="score-val" id="s-p1">0</div>
        </div>
        <div class="timer-box" id="game-timer">00:00</div>
        <div class="score-box" style="border-bottom: 3px solid #ff2a6d">
          <div class="team-lbl">AWAY</div>
          <div class="score-val" id="s-cpu">0</div>
        </div>
      </div>

      <div id="pause-btn" onclick="togglePause()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
          <rect x="6" y="4" width="4" height="16" />
          <rect x="14" y="4" width="4" height="16" />
        </svg>
      </div>

      <div
        id="overlay-msg"
        style="position: absolute; top: 40%; left: 0; width: 100%; text-align: center; font-size: 5rem; font-weight: 800; color: #fff; text-shadow: 0 0 40px #38bdf8; opacity: 0; pointer-events: none; transition: opacity 0.3s"
      >
        GOAL!
      </div>

      <div id="key-hints">WASD: Move | SPACE: Shoot/Tackle | Z: Pass | SHIFT: Sprint | ESC: Pause</div>
    </div>

    <div id="pause-modal" class="ui-screen" style="z-index: 200">
      <h2 class="text-6xl text-white italic font-black mb-8" style="font-family: 'Teko'">PAUSED</h2>
      <button class="pause-menu-btn" onclick="togglePause()">RESUME</button>
      <button class="pause-menu-btn" onclick="restartMatch()">RESTART MATCH</button>
      <button class="pause-menu-btn quit" onclick="quitToTitle()">QUIT TO TITLE</button>
    </div>

    <div id="controls-ui">
      <div id="joy-zone"><div id="joy-stick"></div></div>
      <div class="btn-grid">
        <button id="b-sprint" class="btn">RUN</button>
        <button id="b-pass" class="btn">PASS</button>
        <button id="b-shoot" class="btn">SHOOT</button>
      </div>
    </div>

    <script>
      // --- UI NAV ---
      function showScreen(id) {
        document.querySelectorAll('.ui-screen').forEach((el) => (el.style.display = 'none'));
        const screen = document.getElementById(id);
        if (screen) screen.style.display = 'flex';

        if (id === 'squad-menu') renderSquadMenu();

        if (id === 'ui-layer') {
          document.getElementById('ui-layer').style.display = 'block';
          document.getElementById('controls-ui').style.display = 'block';
          document.getElementById('game-container').style.visibility = 'visible';
        } else {
          document.getElementById('controls-ui').style.display = 'none';
          if (id !== 'pause-modal') document.getElementById('game-container').style.visibility = 'hidden';
        }
      }

      function goToTitle() {
        cleanupEngine();
        showScreen('title-screen');
      }

      let currentMode = 'match';

      function startGame(mode) {
        currentMode = mode;
        if (mode === 'match') {
          showScreen('squad-menu');
        } else {
          // Runner mode WIP: go straight to UI layer so we can iterate quickly.
          initRunnerStub();
          showScreen('ui-layer');
        }
      }

      function beginMatch() {
        initGameEngine();
        resetMatchState();
        showScreen('ui-layer');
        gameActive = true;
        isPaused = false;
      }

      function togglePause() {
        if (!gameActive) return;
        isPaused = !isPaused;
        document.getElementById('pause-modal').style.display = isPaused ? 'flex' : 'none';
      }

      function restartMatch() {
        resetMatchState();
        isPaused = false;
        document.getElementById('pause-modal').style.display = 'none';
      }

      function quitToTitle() {
        cleanupEngine();
        goToTitle();
      }

      // --- SQUAD MENU ---
      const initialSquad = [
        { id: 1, name: 'Donnarumma', number: '99', pos: 'GK', x: 50, y: 88, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Gianluigi_Donnarumma_Euro_2020_Preview.jpg/400px-Gianluigi_Donnarumma_Euro_2020_Preview.jpg' },
        { id: 2, name: 'Aït-Nouri', number: '21', pos: 'LB', x: 15, y: 72, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Rayan_A%C3%AFt-Nouri.png/300px-Rayan_A%C3%AFt-Nouri.png' },
        { id: 3, name: 'Khusanov', number: '45', pos: 'CB', x: 35, y: 76, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7c/Profile_avatar_placeholder_large.png' },
        { id: 4, name: 'Rúben Dias', number: '3', pos: 'CB', x: 65, y: 76, isCaptain: true, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/75/R%C3%BAben_Dias_2018.jpg/300px-R%C3%BAben_Dias_2018.jpg' },
        { id: 5, name: 'M. Nunes', number: '27', pos: 'RB', x: 85, y: 72, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Matheus_Nunes.jpg/300px-Matheus_Nunes.jpg' },
        { id: 6, name: 'Rodri', number: '16', pos: 'CDM', x: 50, y: 58, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Rodri_2018_%28cropped%29.jpg/300px-Rodri_2018_%28cropped%29.jpg' },
        { id: 7, name: 'Reijnders', number: '14', pos: 'CM', x: 30, y: 48, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/63/Tijjani_Reijnders_2023.jpg/300px-Tijjani_Reijnders_2023.jpg' },
        { id: 8, name: 'Foden', number: '47', pos: 'CM', x: 70, y: 48, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/Phil_Foden_2018_%28cropped%29.jpg/300px-Phil_Foden_2018_%28cropped%29.jpg' },
        { id: 9, name: 'Doku', number: '11', pos: 'LW', x: 15, y: 22, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/J%C3%A9r%C3%A9my_Doku_Euro_2020.jpg/300px-J%C3%A9r%C3%A9my_Doku_Euro_2020.jpg' },
        { id: 10, name: 'Haaland', number: '9', pos: 'ST', x: 50, y: 15, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Erling_Haaland_2023_%28cropped%29.jpg/300px-Erling_Haaland_2023_%28cropped%29.jpg' },
        { id: 11, name: 'Cherki', number: '10', pos: 'RW', x: 85, y: 22, img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/98/Rayan_Cherki_2020.jpg/300px-Rayan_Cherki_2020.jpg' },
      ];
      let squadData = [...initialSquad];

      function renderSquadMenu() {
        const container = document.getElementById('pitch-container');
        if (!container) return;
        container.innerHTML = `
          <div class="absolute inset-0 w-full h-full pointer-events-none pitch-pattern">
            <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/40"></div>
            <div class="absolute inset-4 border-2 border-white/60 rounded-lg shadow-[0_0_15px_rgba(255,255,255,0.2)]"></div>
          </div>
          <div class="absolute bottom-2 right-4 text-white/5 font-black text-8xl pointer-events-none select-none italic">CITY</div>
        `;

        squadData.forEach((p) => {
          const el = document.createElement('div');
          el.className = `absolute flex flex-col items-center transform -translate-x-1/2 -translate-y-1/2 group z-10 hover:z-50 transition-all duration-300`;
          el.style.left = `${p.x}%`;
          el.style.top = `${p.y}%`;

          const ring = p.pos === 'GK' ? 'border-green-400' : 'border-sky-300';
          el.innerHTML = `
            <div class="relative w-16 h-16 md:w-24 md:h-24 rounded-full overflow-hidden bg-slate-800 border-2 ${ring} ring-2 group-hover:scale-110 transition-transform shadow-lg cursor-pointer">
              <img src="${p.img}" id="img-${p.id}" class="w-full h-full object-cover" />
              <label class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="text-[8px] text-white font-bold uppercase">Change</span>
                <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(${p.id}, this)" />
              </label>
            </div>
            <div class="mt-1 bg-white/95 px-2 py-0.5 rounded shadow text-[10px] font-black uppercase tracking-tighter">${p.name}</div>
          `;

          container.appendChild(el);
        });
      }

      function handleImageUpload(id, input) {
        const file = input.files[0];
        if (!file) return;

        const r = new FileReader();
        r.onload = (e) => {
          const idx = squadData.findIndex((p) => p.id === id);
          if (idx !== -1) squadData[idx].img = e.target.result;
          document.getElementById(`img-${id}`).src = e.target.result;
        };
        r.readAsDataURL(file);
      }

      // --- THREE.JS ENGINE (MATCH MODE) ---
      const CFG = {
        fieldW: 55,
        fieldL: 90,
        colors: { p1: 0x38bdf8, cpu: 0xff2a6d, gk: 0xffff00, floor: 0x1e293b },
        physics: { playerSpeed: 13, sprintSpeed: 21, ballDrag: 0.97 },
      };

      let scene, camera, renderer, clock;
      let players = [],
        ball;
      let gameActive = false,
        isPaused = false;
      let scores = { p1: 0, cpu: 0 },
        matchTime = 0;
      let input = { x: 0, y: 0, active: false, sprint: false };

      // One animation loop + one-time bindings
      let rafId = 0;
      let controlsBound = false;
      let resizeBound = false;

      // Shared geometries
      const geoTorso = new THREE.CylinderGeometry(0.5, 0.4, 1.3, 8);
      const geoHead = new THREE.SphereGeometry(0.35, 12, 12);
      const geoLimb = new THREE.CylinderGeometry(0.12, 0.1, 1.1, 6);
      const geoBall = new THREE.SphereGeometry(0.7, 16, 16);

      function initGameEngine() {
        const container = document.getElementById('game-container');
        const w = window.innerWidth;
        const h = window.innerHeight;

        cleanupEngine();
        container.innerHTML = '';

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false, powerPreference: 'default' });
        renderer.setSize(w, h);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.setClearColor(0x0f172a);
        container.appendChild(renderer.domElement);

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0f172a);
        scene.fog = new THREE.Fog(0x0f172a, 50, 160);

        camera = new THREE.PerspectiveCamera(40, w / h, 1, 1000);
        camera.position.set(0, 70, 75);
        camera.lookAt(0, 0, 0);

        const ambient = new THREE.HemisphereLight(0xffffff, 0x0f172a, 0.6);
        scene.add(ambient);

        const sun = new THREE.DirectionalLight(0xffffff, 1.0);
        sun.position.set(30, 80, 40);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 2048;
        sun.shadow.mapSize.height = 2048;
        sun.shadow.camera.near = 0.5;
        sun.shadow.camera.far = 200;
        sun.shadow.camera.left = -60;
        sun.shadow.camera.right = 60;
        sun.shadow.camera.top = 60;
        sun.shadow.camera.bottom = -60;
        scene.add(sun);

        buildPitch();
        spawnBall();
        spawnTeams();
        clock = new THREE.Clock();

        if (!resizeBound) {
          window.addEventListener('resize', onResize);
          resizeBound = true;
        }

        if (!controlsBound) {
          setupControls();
          controlsBound = true;
        }

        animate();
      }

      function cleanupEngine() {
        gameActive = false;
        isPaused = false;

        if (rafId) cancelAnimationFrame(rafId);
        rafId = 0;

        try {
          if (renderer) {
            renderer.dispose();
            if (renderer.forceContextLoss) renderer.forceContextLoss();
          }
        } catch {}

        renderer = null;
        scene = null;
        camera = null;
        clock = null;
        players = [];
        ball = null;
      }

      function buildPitch() {
        const floorMat = new THREE.MeshStandardMaterial({ color: CFG.colors.floor, roughness: 0.8 });
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(CFG.fieldW + 40, CFG.fieldL + 40), floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);
      }

      class Player {
        constructor(team, role, pos, x, z) {
          this.team = team;
          this.role = role;
          this.pos = pos;
          this.homePos = new THREE.Vector3(x, 0, z);
          this.mesh = new THREE.Group();
          this.mesh.position.copy(this.homePos);

          let color = team === 'p1' ? CFG.colors.p1 : CFG.colors.cpu;
          if (pos === 'GK') color = CFG.colors.gk;

          const matBody = new THREE.MeshStandardMaterial({ color: color, roughness: 0.4 });
          const matSkin = new THREE.MeshStandardMaterial({ color: 0xccaa88, roughness: 0.5 });

          this.hips = new THREE.Group();
          this.hips.position.y = 1.8;
          this.mesh.add(this.hips);

          const torso = new THREE.Mesh(geoTorso, matBody);
          torso.position.y = 0.65;
          torso.scale.z = 0.8;
          torso.castShadow = true;
          this.hips.add(torso);

          const head = new THREE.Mesh(geoHead, matSkin);
          head.position.y = 1.5;
          head.castShadow = true;
          this.hips.add(head);

          const createLimb = (x, y, mat) => {
            const g = new THREE.Group();
            g.position.set(x, y, 0);
            const m = new THREE.Mesh(geoLimb, mat);
            m.position.y = -0.55;
            m.castShadow = true;
            g.add(m);
            return g;
          };

          this.armL = createLimb(-0.65, 1.2, matSkin);
          this.hips.add(this.armL);
          this.armR = createLimb(0.65, 1.2, matSkin);
          this.hips.add(this.armR);
          this.legL = createLimb(-0.25, 0, matBody);
          this.hips.add(this.legL);
          this.legR = createLimb(0.25, 0, matBody);
          this.hips.add(this.legR);

          const ring = new THREE.Mesh(
            new THREE.RingGeometry(0.8, 1, 16),
            new THREE.MeshBasicMaterial({ color: 0xffff00, side: THREE.DoubleSide })
          );
          ring.rotation.x = -Math.PI / 2;
          ring.position.y = 0.05;
          if (role !== 'human') ring.visible = false;
          this.mesh.add(ring);
          this.ring = ring;

          scene.add(this.mesh);
          this.velocity = new THREE.Vector3();
          this.animTime = Math.random() * 100;
          this.hasBall = false;
          this.cooldown = 0;
        }

        update(dt) {
          if (this.cooldown > 0) this.cooldown -= dt;

          let moveDir = new THREE.Vector3();
          let speed = CFG.physics.playerSpeed;

          if (this.role === 'human') {
            if (input.active) moveDir.set(input.x, 0, input.y);
            if (input.sprint) speed = CFG.physics.sprintSpeed;
          }

          if (moveDir.lengthSq() > 0.01) {
            const targetRot = Math.atan2(moveDir.x, moveDir.z);
            let rotDiff = targetRot - this.mesh.rotation.y;
            while (rotDiff > Math.PI) rotDiff -= Math.PI * 2;
            while (rotDiff < -Math.PI) rotDiff += Math.PI * 2;
            this.mesh.rotation.y += rotDiff * 10 * dt;

            this.velocity.lerp(moveDir.normalize().multiplyScalar(speed), dt * 8);
            this.animTime += dt * speed * 0.8;

            this.legL.rotation.x = Math.sin(this.animTime);
            this.legR.rotation.x = Math.sin(this.animTime + Math.PI);
            this.armL.rotation.x = Math.sin(this.animTime + Math.PI) * 0.7;
            this.armR.rotation.x = Math.sin(this.animTime) * 0.7;
          } else {
            this.velocity.lerp(new THREE.Vector3(), dt * 8);
            this.legL.rotation.x = 0;
            this.legR.rotation.x = 0;
          }

          this.mesh.position.add(this.velocity.clone().multiplyScalar(dt));

          const hw = CFG.fieldW / 2,
            hl = CFG.fieldL / 2;
          this.mesh.position.x = Math.max(-hw, Math.min(hw, this.mesh.position.x));
          this.mesh.position.z = Math.max(-hl, Math.min(hl, this.mesh.position.z));

          this.handleBall();
        }

        handleBall() {
          if (!ball.owner && this.cooldown <= 0) {
            if (this.mesh.position.distanceTo(ball.mesh.position) < 2.0) {
              ball.owner = this;
              this.hasBall = true;
            }
          }

          if (this.hasBall) {
            ball.velocity.set(0, 0, 0);
            const offset = new THREE.Vector3(0, 0, 1.2).applyAxisAngle(new THREE.Vector3(0, 1, 0), this.mesh.rotation.y);
            ball.mesh.position.copy(this.mesh.position).add(offset);
            ball.mesh.position.y = 0.5;
          }
        }

        shoot() {
          if (!this.hasBall) return;
          this.releaseBall(45, 6);
        }

        pass() {
          if (!this.hasBall) return;
          this.releaseBall(25, 0.5);
        }

        slide() {
          if (this.hasBall) return;
          this.cooldown = 1.0;
        }

        releaseBall(fwd, up) {
          this.hasBall = false;
          this.cooldown = 0.5;
          ball.owner = null;
          let dir = new THREE.Vector3(0, 0, 1).applyAxisAngle(new THREE.Vector3(0, 1, 0), this.mesh.rotation.y);
          ball.velocity.copy(dir).multiplyScalar(fwd);
          ball.velocity.y = up;
        }
      }

      function spawnBall() {
        const mat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.2 });
        const mesh = new THREE.Mesh(geoBall, mat);
        mesh.castShadow = true;
        scene.add(mesh);
        ball = { mesh: mesh, velocity: new THREE.Vector3(), owner: null };
      }

      function updateBall(dt) {
        if (ball.owner) return;

        ball.velocity.y -= 30 * dt;
        ball.velocity.multiplyScalar(CFG.physics.ballDrag);
        ball.mesh.position.add(ball.velocity.clone().multiplyScalar(dt));

        if (ball.mesh.position.y < 0.7) {
          ball.mesh.position.y = 0.7;
          ball.velocity.y *= -0.6;
        }

        if (Math.abs(ball.mesh.position.x) > CFG.fieldW / 2) ball.velocity.x *= -0.8;

        if (Math.abs(ball.mesh.position.z) > CFG.fieldL / 2) {
          if (Math.abs(ball.mesh.position.x) < 7) {
            scores[ball.mesh.position.z < 0 ? 'p1' : 'cpu']++;
            updateScore();
            resetPositions();
          } else ball.velocity.z *= -0.8;
        }
      }

      function spawnTeams() {
        players = [];
        players.push(new Player('p1', 'cpu', 'GK', 0, 42));
        players.push(new Player('p1', 'cpu', 'DEF', 0, 25));
        players.push(new Player('p1', 'cpu', 'MID', -15, 10));
        players.push(new Player('p1', 'human', 'FWD', 0, 0));

        players.push(new Player('cpu', 'cpu', 'GK', 0, -42));
        players.push(new Player('cpu', 'cpu', 'DEF', 0, -25));
        players.push(new Player('cpu', 'cpu', 'MID', 15, -10));
        players.push(new Player('cpu', 'cpu', 'FWD', 0, -5));

        resetPositions();
      }

      function resetPositions() {
        ball.owner = null;
        ball.velocity.set(0, 0, 0);
        ball.mesh.position.set(0, 5, 0);
        players.forEach((p) => {
          p.mesh.position.copy(p.homePos);
          p.hasBall = false;
          p.cooldown = 0;
        });

        setTimeout(() => {
          const p1Striker = players.find((p) => p.team === 'p1' && p.pos === 'FWD');
          if (p1Striker) {
            ball.owner = p1Striker;
            p1Striker.hasBall = true;
          }
        }, 500);
      }

      function updateScore() {
        document.getElementById('s-p1').innerText = scores.p1;
        document.getElementById('s-cpu').innerText = scores.cpu;
        const msg = document.getElementById('overlay-msg');
        msg.style.opacity = 1;
        setTimeout(() => {
          msg.style.opacity = 0;
        }, 1200);
      }

      function updateCamera() {
        const target = ball.owner ? ball.owner.mesh.position : ball.mesh.position;
        camera.position.lerp(new THREE.Vector3(0, 50, target.z + 55), 0.1);
        camera.lookAt(target.x * 0.1, 0, target.z);
      }

      function animate() {
        rafId = requestAnimationFrame(animate);
        if (!renderer || !scene || !camera) return;

        if (gameActive && !isPaused) {
          const dt = Math.min(clock.getDelta(), 0.1);
          matchTime += dt;
          const m = Math.floor(matchTime / 60);
          const s = Math.floor(matchTime % 60);
          document.getElementById('game-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;

          updateBall(dt);
          players.forEach((p) => p.update(dt));
          updateCamera();

          // basic auto-selection (closest P1) if no owner
          if (!ball.owner || ball.owner.team !== 'p1') {
            let closest = null,
              minD = Infinity;
            players.forEach((p) => {
              if (p.team === 'p1') {
                p.role = 'cpu';
                p.ring.visible = false;
                const d = p.mesh.position.distanceTo(ball.mesh.position);
                if (d < minD) {
                  minD = d;
                  closest = p;
                }
              }
            });
            if (closest) {
              closest.role = 'human';
              closest.ring.visible = true;
            }
          } else {
            players.forEach((p) => {
              if (p.team === 'p1') {
                p.role = p === ball.owner ? 'human' : 'cpu';
                p.ring.visible = p.role === 'human';
              }
            });
          }
        }

        renderer.render(scene, camera);
      }

      function setupControls() {
        const zone = document.getElementById('joy-zone');
        const stick = document.getElementById('joy-stick');
        let startX = 0,
          startY = 0;
        let isMouseDown = false;

        function startJoy(x, y) {
          input.active = true;
          const r = zone.getBoundingClientRect();
          startX = r.left + 70;
          startY = r.top + 70;
          moveStick(x, y);
        }

        function moveStick(cx, cy) {
          let dx = cx - startX;
          let dy = cy - startY;
          const d = Math.sqrt(dx * dx + dy * dy);
          if (d > 40) {
            dx = (dx / d) * 40;
            dy = (dy / d) * 40;
          }
          stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
          input.x = dx / 40;
          input.y = dy / 40;
        }

        function endJoy() {
          input.active = false;
          input.x = 0;
          input.y = 0;
          stick.style.transform = `translate(-50%, -50%)`;
        }

        zone.addEventListener('touchstart', (e) => {
          e.preventDefault();
          startJoy(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        });
        zone.addEventListener('touchmove', (e) => {
          e.preventDefault();
          if (input.active) moveStick(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        });
        zone.addEventListener('touchend', endJoy);

        zone.addEventListener('mousedown', (e) => {
          e.preventDefault();
          isMouseDown = true;
          startJoy(e.clientX, e.clientY);
        });
        window.addEventListener('mousemove', (e) => {
          if (!isMouseDown) return;
          e.preventDefault();
          moveStick(e.clientX, e.clientY);
        });
        window.addEventListener('mouseup', () => {
          if (!isMouseDown) return;
          endJoy();
          isMouseDown = false;
        });

        const bind = (id, act) => {
          const b = document.getElementById(id);
          const trig = (v) => {
            if (act === 'sprint') input.sprint = v;

            if (v && !isPaused) {
              const p = players.find((pl) => pl.role === 'human');
              if (!p) return;
              if (act === 'shoot') {
                if (p.hasBall) p.shoot();
                else p.slide();
              }
              if (act === 'pass') {
                if (p.hasBall) p.pass();
              }
            }
          };

          b.addEventListener('touchstart', (e) => {
            e.preventDefault();
            trig(true);
          });
          b.addEventListener('touchend', (e) => {
            e.preventDefault();
            trig(false);
          });
          b.addEventListener('mousedown', () => trig(true));
          b.addEventListener('mouseup', () => trig(false));
        };

        bind('b-sprint', 'sprint');
        bind('b-shoot', 'shoot');
        bind('b-pass', 'pass');

        window.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') togglePause();
          if (isPaused) return;

          const k = e.key.toLowerCase();
          if (['w', 'arrowup'].includes(k)) {
            input.active = true;
            input.y = -1;
          }
          if (['s', 'arrowdown'].includes(k)) {
            input.active = true;
            input.y = 1;
          }
          if (['a', 'arrowleft'].includes(k)) {
            input.active = true;
            input.x = -1;
          }
          if (['d', 'arrowright'].includes(k)) {
            input.active = true;
            input.x = 1;
          }
          if (k === 'shift') input.sprint = true;

          if (e.code === 'Space') {
            const p = players.find((pl) => pl.role === 'human');
            if (p && p.hasBall) p.shoot();
            else if (p) p.slide();
          }
          if (k === 'z') {
            const p = players.find((pl) => pl.role === 'human');
            if (p && p.hasBall) p.pass();
          }
        });

        window.addEventListener('keyup', (e) => {
          const k = e.key.toLowerCase();
          if (['w', 's', 'arrowup', 'arrowdown'].includes(k)) input.y = 0;
          if (['a', 'd', 'arrowleft', 'arrowright'].includes(k)) input.x = 0;
          if (input.x === 0 && input.y === 0) input.active = false;
          if (k === 'shift') input.sprint = false;
        });
      }

      function onResize() {
        if (!camera || !renderer) return;
        const w = window.innerWidth;
        const h = window.innerHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      }

      function resetMatchState() {
        scores = { p1: 0, cpu: 0 };
        matchTime = 0;
        document.getElementById('s-p1').innerText = '0';
        document.getElementById('s-cpu').innerText = '0';
        document.getElementById('game-timer').innerText = '00:00';
        if (players.length > 0) resetPositions();
      }

      // --- RUNNER MODE STUB (placeholder) ---
      function initRunnerStub() {
        cleanupEngine();
        document.getElementById('overlay-msg').textContent = 'RUNNER MODE (WIP)';
        document.getElementById('overlay-msg').style.opacity = 1;
        setTimeout(() => (document.getElementById('overlay-msg').style.opacity = 0), 1200);
        gameActive = true;
        isPaused = false;
      }

      // boot
      showScreen('title-screen');
    </script>
  </body>
</html>
