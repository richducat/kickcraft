<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>FC Street</title>

  <!-- Vendored library (mobile-safe: no external CDN required) -->
  <script src="../vendor/three.r128.min.js"></script>
  <!-- Three.js examples helpers (vendored) -->
  <script src="../vendor/three-extras/GLTFLoader.js"></script>
  <script src="../vendor/three-extras/SkeletonUtils.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;800&family=Teko:wght@500&display=swap');

    body {
      margin: 0;
      overflow: hidden;
      background: #0f172a;
      user-select: none;
      -webkit-touch-callout: none;
      font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      touch-action: none;
    }

    #game-container {
      position: absolute;
      inset: 0;
      z-index: 1;
      background: #1a1a2e;
    }

    .ui-screen {
      position: absolute;
      inset: 0;
      display: none;
      z-index: 50;
      pointer-events: none;
    }

    .interactive { pointer-events: auto; }

    #debug-status {
      position: absolute;
      bottom: 5px;
      left: 5px;
      color: lime;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 10px;
      opacity: 0.55;
      z-index: 999;
      pointer-events: none;
    }

    /* Title */
    #title-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #0f172a;
      pointer-events: auto;
      text-align: center;
      padding: 24px;
    }
    #title-screen h1 {
      margin: 0;
      font-family: 'Teko', system-ui, sans-serif;
      font-size: min(84px, 18vw);
      font-weight: 900;
      font-style: italic;
      color: #fff;
      letter-spacing: -0.02em;
      text-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    #title-screen h1 span { color: #38bdf8; }
    #title-screen .tagline {
      margin-top: 6px;
      color: rgba(148,163,184,0.9);
      font-weight: 800;
      letter-spacing: 0.45em;
      font-size: 12px;
      text-transform: uppercase;
    }
    #title-screen button {
      margin-top: 28px;
      padding: 16px 48px;
      border: 0;
      background: #fff;
      color: #000;
      font-weight: 900;
      font-size: 20px;
      text-transform: uppercase;
      cursor: pointer;
      transform: translateZ(0);
      clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
    }

    /* Squad */
    #squad-menu {
      background: #0f172a;
      pointer-events: auto;
      overflow: auto;
    }
    .squad-wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .squad-card {
      width: min(1100px, 100%);
      background: #0b1220;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.18);
    }
    .squad-head {
      background: #1C2C5B;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .squad-head h2 {
      margin: 0;
      font-family: 'Montserrat', system-ui, sans-serif;
      font-weight: 900;
      font-style: italic;
      color: #fff;
      font-size: 22px;
    }
    .squad-head h2 span { color: #38bdf8; }
    .squad-head button {
      background: transparent;
      border: 0;
      color: rgba(255,255,255,0.7);
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
    }
    #pitch-container {
      width: 100%;
      aspect-ratio: 16 / 10;
      background: #0f172a;
      position: relative;
      overflow: hidden;
    }
    .squad-foot {
      background: #1C2C5B;
      padding: 12px;
      display: flex;
      justify-content: center;
    }
    .squad-foot button {
      padding: 14px 44px;
      border: 0;
      background: #38bdf8;
      color: #001018;
      font-weight: 900;
      font-size: 18px;
      text-transform: uppercase;
      cursor: pointer;
      clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
    }

    /* Pitch preview pattern */
    .pitch-pattern {
      background-color: #1a4d2e;
      background-image: repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(0,0,0,0.1) 50px, rgba(0,0,0,0.1) 100px);
    }

    /* HUD */
    #scoreboard {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 0;
      background: rgba(20, 20, 30, 0.95);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }

    .score-box {
      padding: 5px 25px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 60px;
    }

    .score-val {
      font-family: 'Teko', system-ui, sans-serif;
      font-size: 2.5rem;
      color: #fff;
      line-height: 0.9;
    }

    .team-lbl {
      font-size: 0.7rem;
      color: #aaa;
      font-weight: 800;
      letter-spacing: 1px;
    }

    .timer-box {
      background: rgba(255,255,255,0.05);
      padding: 0 15px;
      display: flex;
      align-items: center;
      color: #fff;
      font-family: 'Teko', system-ui, sans-serif;
      font-size: 1.8rem;
    }

    #pause-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    #overlay-msg {
      position: absolute;
      top: 40%;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: min(72px, 16vw);
      font-weight: 900;
      color: #fff;
      opacity: 0;
      transition: opacity 0.3s;
      text-shadow: 0 12px 28px rgba(0,0,0,0.4);
      pointer-events: none;
    }

    /* Pause */
    #pause-modal {
      background: rgba(15, 23, 42, 0.95);
      z-index: 200;
      pointer-events: auto;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    #pause-modal h2 {
      font-family: 'Teko', system-ui, sans-serif;
      font-size: min(72px, 14vw);
      color: #fff;
      font-style: italic;
      font-weight: 900;
      margin: 0 0 16px 0;
    }

    .pause-menu-btn {
      background: transparent;
      border: 2px solid white;
      color: white;
      padding: 15px 40px;
      margin: 6px;
      font-family: 'Teko', system-ui, sans-serif;
      font-size: 2rem;
      width: 250px;
      cursor: pointer;
    }

    /* Controls */
    #controls-ui {
      position: absolute;
      inset: 0;
      z-index: 20;
      display: none;
      pointer-events: none;
    }

    #joy-zone {
      position: absolute;
      bottom: 40px;
      left: 40px;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      pointer-events: auto;
    }

    #joy-stick {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 50px;
      height: 50px;
      background: #fff;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .btn-grid {
      position: absolute;
      bottom: 40px;
      right: 40px;
      display: grid;
      gap: 20px;
      grid-template-areas: ". sprint" "pass shoot";
      pointer-events: auto;
    }

    .btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: none;
      color: #fff;
      font-family: 'Teko', system-ui, sans-serif;
      font-size: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    #b-shoot { grid-area: shoot; background: #ff2a6d; width: 95px; height: 95px; font-size: 1.8rem; }
    #b-pass { grid-area: pass; background: #38bdf8; }
    #b-sprint { grid-area: sprint; background: #ffae00; width: 65px; height: 65px; font-size: 1rem; }

    /* Safety overlay for script errors (helps when iOS hides errors) */
    #diag {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 9999;
      background: #0b1220;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding: 20px;
    }
  </style>
</head>
<body>

  <div id="diag">
    <div style="max-width:720px;margin:0 auto;">
      <div style="font-weight:900;font-size:28px;letter-spacing:-0.02em;">FC Street couldn’t start</div>
      <div id="diag-msg" style="margin-top:10px;opacity:0.85;line-height:1.4;"></div>
      <div style="margin-top:14px;opacity:0.75;font-size:12px;">Tip: open in Safari/Chrome (not inside Telegram), then refresh.</div>
    </div>
  </div>

  <script>
    (function(){
      function show(msg){
        var box=document.getElementById('diag');
        var m=document.getElementById('diag-msg');
        if(!box||!m) return;
        m.textContent=msg;
        box.style.display='block';
      }
      window.addEventListener('error', function(e){ show('Error: ' + (e && e.message ? e.message : 'unknown')); });
      window.addEventListener('unhandledrejection', function(e){ show('Error: ' + (e && e.reason ? (e.reason.message || String(e.reason)) : 'unknown')); });
      setTimeout(function(){ if(typeof window.THREE==='undefined') show('Three.js did not load.'); }, 1500);
    })();
  </script>

  <div id="debug-status">Initializing...</div>

  <!-- TITLE -->
  <div id="title-screen" class="ui-screen">
    <h1>FC <span>STREET</span></h1>
    <div class="tagline">ARCADE EDITION</div>
    <button onclick="goToSquad()">START GAME</button>
  </div>

  <!-- SQUAD -->
  <div id="squad-menu" class="ui-screen">
    <div class="squad-wrap">
      <div class="squad-card">
        <div class="squad-head">
          <h2>MAN CITY <span>25/26</span></h2>
          <button onclick="goToTitle()">BACK</button>
        </div>
        <div id="pitch-container"></div>
        <div class="squad-foot">
          <button onclick="startGame()">KICK OFF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- GAME -->
  <div id="game-container"></div>

  <!-- HUD -->
  <div id="ui-layer" class="ui-screen">
    <div id="scoreboard" class="interactive">
      <div class="score-box" style="border-bottom: 3px solid #38bdf8"><div class="team-lbl">CITY</div><div class="score-val" id="s-p1">0</div></div>
      <div class="timer-box" id="game-timer">00:00</div>
      <div class="score-box" style="border-bottom: 3px solid #ff2a6d"><div class="team-lbl">AWAY</div><div class="score-val" id="s-cpu">0</div></div>
    </div>
    <div id="pause-btn" class="interactive" onclick="togglePause()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
    </div>
    <div id="overlay-msg">GOAL!</div>
  </div>

  <!-- PAUSE -->
  <div id="pause-modal" class="ui-screen" style="display:none;">
    <h2>PAUSED</h2>
    <button class="pause-menu-btn" onclick="togglePause()">RESUME</button>
    <button class="pause-menu-btn" onclick="restartMatch()">RESTART</button>
    <button class="pause-menu-btn" onclick="quitToMenu()" style="border-color: #ff2a6d;">QUIT</button>
  </div>

  <!-- CONTROLS -->
  <div id="controls-ui">
    <div id="joy-zone"><div id="joy-stick"></div></div>
    <div class="btn-grid">
      <button id="b-sprint" class="btn">RUN</button>
      <button id="b-pass" class="btn">PASS</button>
      <button id="b-shoot" class="btn">SHOOT</button>
    </div>
  </div>

<script>
// --- CONFIG ---
const CFG = {
  fieldW: 55,
  fieldL: 90,
  colors: { p1: 0x38bdf8, cpu: 0xff2a6d, gk: 0xffff00, floor: 0x1a4d2e },
  physics: { playerSpeed: 13, sprintSpeed: 21, ballDrag: 0.97 }
};

// --- STATE ---
let scene, camera, renderer, clock, players = [], ball;
let gameActive = false, isPaused = false;
let scores = { p1: 0, cpu: 0 }, matchTime = 0;
let input = { x:0, y:0, active:false, sprint:false };
let engineInitialized = false;

// --- FC Mobile vibe (placeholder): humanoid model + animations ---
let baseHumanoid = null;          // { scene, animations }
let humanoidMixerById = new Map();
let humanoidReady = false;

// --- MENU LOGIC ---
const initialSquad = [
  { id: 1, name: "Donnarumma", number: "99", pos: "GK", x: 50, y: 88, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Gianluigi_Donnarumma_Euro_2020_Preview.jpg/400px-Gianluigi_Donnarumma_Euro_2020_Preview.jpg" },
  { id: 2, name: "Aït-Nouri", number: "21", pos: "LB", x: 15, y: 72, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Rayan_A%C3%AFt-Nouri.png/300px-Rayan_A%C3%AFt-Nouri.png" },
  { id: 3, name: "Khusanov", number: "45", pos: "CB", x: 35, y: 76, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/7c/Profile_avatar_placeholder_large.png" },
  { id: 4, name: "Rúben Dias", number: "3", pos: "CB", x: 65, y: 76, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/75/R%C3%BAben_Dias_2018.jpg/300px-R%C3%BAben_Dias_2018.jpg" },
  { id: 5, name: "M. Nunes", number: "27", pos: "RB", x: 85, y: 72, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Matheus_Nunes.jpg/300px-Matheus_Nunes.jpg" },
  { id: 6, name: "Rodri", number: "16", pos: "CDM", x: 50, y: 58, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Rodri_2018_%28cropped%29.jpg/300px-Rodri_2018_%28cropped%29.jpg" },
  { id: 7, name: "Reijnders", number: "14", pos: "CM", x: 30, y: 48, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/63/Tijjani_Reijnders_2023.jpg/300px-Tijjani_Reijnders_2023.jpg" },
  { id: 8, name: "Foden", number: "47", pos: "CM", x: 70, y: 48, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/Phil_Foden_2018_%28cropped%29.jpg/300px-Phil_Foden_2018_%28cropped%29.jpg" },
  { id: 9, name: "Doku", number: "11", pos: "LW", x: 15, y: 22, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/J%C3%A9r%C3%A9my_Doku_Euro_2020.jpg/300px-J%C3%A9r%C3%A9my_Doku_Euro_2020.jpg" },
  { id: 10, name: "Haaland", number: "9", pos: "ST", x: 50, y: 15, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Erling_Haaland_2023_%28cropped%29.jpg/300px-Erling_Haaland_2023_%28cropped%29.jpg" },
  { id: 11, name: "Cherki", number: "10", pos: "RW", x: 85, y: 22, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/98/Rayan_Cherki_2020.jpg/300px-Rayan_Cherki_2020.jpg" },
];

function showScreen(id) {
  document.querySelectorAll('.ui-screen').forEach(el => el.style.display = 'none');
  document.getElementById(id).style.display = id === 'pause-modal' ? 'flex' : 'block';
  if (id === 'title-screen') document.getElementById('title-screen').style.display = 'flex';

  if (id === 'squad-menu') {
    const container = document.getElementById('pitch-container');
    if (container && container.innerHTML === "") {
      container.innerHTML = `
        <div class="pitch-pattern" style="position:absolute; inset:0; width:100%; height:100%; pointer-events:none;">
          <div style="position:absolute; inset:0; background: linear-gradient(to bottom, rgba(0,0,0,0.2), transparent, rgba(0,0,0,0.4));"></div>
          <div style="position:absolute; inset:16px; border:2px solid rgba(255,255,255,0.6); border-radius: 12px; box-shadow: 0 0 15px rgba(255,255,255,0.2);"></div>
        </div>`;
      initialSquad.forEach(p => {
        const div = document.createElement('div');
        div.style.position = 'absolute';
        div.style.left = p.x + '%';
        div.style.top = p.y + '%';
        div.style.transform = 'translate(-50%, -50%)';
        div.style.display = 'flex';
        div.style.flexDirection = 'column';
        div.style.alignItems = 'center';
        const ring = p.pos==='GK' ? 'rgba(34,197,94,1)' : 'rgba(125,211,252,1)';
        div.innerHTML = `
          <div style="width:64px;height:64px;border-radius:999px;border:2px solid ${ring};background:#0b1220;overflow:hidden;">
            <img src="${p.img}" style="width:100%;height:100%;object-fit:cover" />
          </div>
          <div style="margin-top:6px;background:#fff;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:900;color:#000;text-transform:uppercase;">${p.name}</div>
        `;
        container.appendChild(div);
      });
    }
  }

  if (id === 'ui-layer') document.getElementById('controls-ui').style.display = 'block';
  else document.getElementById('controls-ui').style.display = 'none';
}

function goToTitle() { showScreen('title-screen'); }
function goToSquad() { showScreen('squad-menu'); }

function startGame() {
  if (!engineInitialized) {
    initEngine();
    engineInitialized = true;
  }
  resetGame();
  showScreen('ui-layer');
  gameActive = true;
  isPaused = false;
  setTimeout(() => onResize(), 100);
}

function togglePause() {
  if (!gameActive) return;
  isPaused = !isPaused;
  document.getElementById('pause-modal').style.display = isPaused ? 'flex' : 'none';
}

function restartMatch() { resetGame(); togglePause(); }
function quitToMenu() { gameActive = false; isPaused = false; goToTitle(); }

function resetGame() {
  scores = {p1:0, cpu:0};
  matchTime = 0;
  document.getElementById('s-p1').innerText='0';
  document.getElementById('s-cpu').innerText='0';
  if (players.length>0) resetPositions();
}

// --- ENGINE ---
function initEngine() {
  const container = document.getElementById('game-container');
  const w = window.innerWidth, h = window.innerHeight;

  renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
  renderer.setSize(w, h);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
  renderer.setClearColor(0x0f172a);
  container.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0f172a);

  camera = new THREE.PerspectiveCamera(45, w/h, 1, 1000);
  camera.position.set(0, 70, 70);
  camera.lookAt(0,0,0);

  scene.add(new THREE.AmbientLight(0xffffff, 1.5));

  buildWorld();
  spawnEntities();

  clock = new THREE.Clock();
  window.addEventListener('resize', onResize);
  setupInputs();

  document.getElementById('debug-status').innerText = "Game Active";

  // Load a lightweight humanoid (placeholder) so we can swap cylinders → people.
  // Note: Soldier.glb is from three.js examples (MIT) and is a temporary placeholder.
  try {
    const loader = new THREE.GLTFLoader();
    loader.load(
      './assets/Soldier.glb',
      (gltf) => {
        baseHumanoid = { scene: gltf.scene, animations: gltf.animations || [] };
        humanoidReady = true;
        applyHumanoidsToExistingPlayers();
      },
      undefined,
      () => {}
    );
  } catch (e) {}

  animate();
}

function applyHumanoidsToExistingPlayers(){
  if(!humanoidReady || !baseHumanoid) return;
  players.forEach((p) => {
    // If it already has a skinned humanoid, skip.
    if (p.__humanoidApplied) return;
    // Keep the selection ring for the human player.
    const keep = [];
    p.mesh.children.forEach((c) => { if (c && c.geometry && c.geometry.type === 'RingGeometry') keep.push(c); });
    p.mesh.clear();
    keep.forEach((c)=>p.mesh.add(c));

    const model = THREE.SkeletonUtils.clone(baseHumanoid.scene);
    // Scale/position to fit our pitch scale
    model.scale.set(1.1, 1.1, 1.1);
    model.position.y = 0;

    // Kit colors (very simple tint via material color when possible)
    const kitColor = (p.team==='p1') ? 0x38bdf8 : 0xff2a6d;
    model.traverse((o)=>{
      if(o.isMesh && o.material){
        // If it's a multi-material array, skip for safety.
        if(Array.isArray(o.material)) return;
        if(o.material.color) o.material.color.setHex(kitColor);
        o.castShadow = false; o.receiveShadow = false;
      }
    });

    p.mesh.add(model);

    // Animation mixer
    const mixer = new THREE.AnimationMixer(model);
    // Prefer "Run" when moving, otherwise "Idle".
    const idleClip = baseHumanoid.animations.find(a => /idle/i.test(a.name)) || baseHumanoid.animations[0];
    const runClip  = baseHumanoid.animations.find(a => /run/i.test(a.name));
    p.__idle = idleClip ? mixer.clipAction(idleClip) : null;
    p.__run  = runClip  ? mixer.clipAction(runClip)  : null;
    if(p.__idle){ p.__idle.play(); }
    humanoidMixerById.set(p, mixer);
    p.__humanoidApplied = true;
  });
}

function buildWorld() {
  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(CFG.fieldW+20, CFG.fieldL+20),
    new THREE.MeshBasicMaterial({ color: CFG.colors.floor })
  );
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);

  const lineMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 });
  const addLine = (w,h,x,z) => {
    const m = new THREE.Mesh(new THREE.PlaneGeometry(w,h), lineMat);
    m.rotation.x = -Math.PI/2;
    m.position.set(x, 0.05, z);
    scene.add(m);
  };
  addLine(CFG.fieldW, 0.5, 0, CFG.fieldL/2);
  addLine(CFG.fieldW, 0.5, 0, -CFG.fieldL/2);
  addLine(0.5, CFG.fieldL, CFG.fieldW/2, 0);
  addLine(0.5, CFG.fieldL, -CFG.fieldW/2, 0);
  addLine(CFG.fieldW, 0.5, 0, 0);

  const goalMat = new THREE.MeshBasicMaterial({ color: 0xeeeeee });
  const makeGoal = (z) => {
    const g = new THREE.Group();
    g.position.z = z;
    const p1 = new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,6), goalMat); p1.position.set(-7,3,0);
    const p2 = new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,6), goalMat); p2.position.set(7,3,0);
    const bar = new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,14), goalMat); bar.rotation.z=Math.PI/2; bar.position.set(0,6,0);
    g.add(p1,p2,bar);
    scene.add(g);
  };
  makeGoal(CFG.fieldL/2);
  makeGoal(-CFG.fieldL/2);
}

function spawnEntities() {
  ball = {
    mesh: new THREE.Mesh(new THREE.SphereGeometry(0.7, 16, 16), new THREE.MeshBasicMaterial({color:0xffffff})),
    velocity: new THREE.Vector3(),
    owner: null
  };
  scene.add(ball.mesh);

  const makePlayer = (team, role, pos, x, z) => {
    const col = team==='p1'?CFG.colors.p1:CFG.colors.cpu;
    const mat = new THREE.MeshBasicMaterial({ color: pos==='GK'?CFG.colors.gk:col });
    const group = new THREE.Group();
    group.position.set(x, 0, z);

    const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1.8), mat); body.position.y = 0.9;
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshBasicMaterial({color:0xffccaa})); head.position.y = 2.0;
    group.add(body, head);

    if (role === 'human') {
      const ring = new THREE.Mesh(new THREE.RingGeometry(0.8,1,16), new THREE.MeshBasicMaterial({color:0xffff00, side: THREE.DoubleSide}));
      ring.rotation.x = -Math.PI/2; ring.position.y=0.05;
      group.add(ring);
    }

    scene.add(group);
    players.push({ team, role, pos, mesh: group, homePos: new THREE.Vector3(x,0,z), velocity: new THREE.Vector3(), hasBall: false, cooldown: 0 });
  };

  players = [];
  makePlayer('p1', 'cpu', 'GK', 0, 42);
  makePlayer('p1', 'cpu', 'DEF', 0, 25);
  makePlayer('p1', 'cpu', 'MID', -10, 10);
  makePlayer('p1', 'human', 'FWD', 0, 0);
  makePlayer('cpu', 'cpu', 'GK', 0, -42);
  makePlayer('cpu', 'cpu', 'DEF', 0, -25);
  makePlayer('cpu', 'cpu', 'MID', 10, -10);
  makePlayer('cpu', 'cpu', 'FWD', 0, -5);

  resetPositions();
}

function resetPositions() {
  ball.owner = null;
  ball.velocity.set(0,0,0);
  ball.mesh.position.set(0,5,0);
  players.forEach(p => { p.mesh.position.copy(p.homePos); p.hasBall=false; p.cooldown=0; });
  setTimeout(() => {
    const striker = players.find(p => p.role==='human');
    if (striker) { striker.hasBall = true; ball.owner = striker; }
  }, 500);
}

function animate() {
  requestAnimationFrame(animate);
  if (!renderer || !scene) return;

  if (gameActive && !isPaused) {
    const dt = 0.016;
    matchTime += dt;
    let m = Math.floor(matchTime/60); let s = Math.floor(matchTime%60);
    document.getElementById('game-timer').innerText = `${m}:${s<10?'0':''}${s}`;

    if (!ball.owner) {
      ball.velocity.y -= 20 * dt;
      ball.velocity.multiplyScalar(CFG.physics.ballDrag);
      ball.mesh.position.add(ball.velocity.clone().multiplyScalar(dt));
      if (ball.mesh.position.y < 0.7) { ball.mesh.position.y = 0.7; ball.velocity.y *= -0.6; }

      if (Math.abs(ball.mesh.position.z) > CFG.fieldL/2) {
        if (Math.abs(ball.mesh.position.x) < 7) {
          scores[ball.mesh.position.z<0?'p1':'cpu']++;
          document.getElementById('s-p1').innerText = scores.p1;
          document.getElementById('s-cpu').innerText = scores.cpu;
          const msg = document.getElementById('overlay-msg');
          msg.style.opacity = 1;
          setTimeout(()=>msg.style.opacity=0, 2000);
          resetPositions();
        } else ball.velocity.z *= -0.8;
      }
      if (Math.abs(ball.mesh.position.x) > CFG.fieldW/2) ball.velocity.x *= -0.8;
    } else {
      const off = new THREE.Vector3(0,0,1.2).applyAxisAngle(new THREE.Vector3(0,1,0), ball.owner.mesh.rotation.y);
      ball.mesh.position.copy(ball.owner.mesh.position).add(off);
      ball.mesh.position.y = ball.owner.pos === 'GK' ? 1.5 : 0.5;
    }

    players.forEach(p => {
      if (p.cooldown > 0) p.cooldown -= dt;
      let dir = new THREE.Vector3();
      let spd = CFG.physics.playerSpeed;

      if (p.role === 'human') {
        if (input.active) dir.set(input.x, 0, input.y);
        if (input.sprint) spd = CFG.physics.sprintSpeed;

        const bShoot = document.getElementById('b-shoot');
        const bPass = document.getElementById('b-pass');
        if (p.pos === 'GK' && p.hasBall) { bShoot.innerText="PUNT"; bPass.innerText="THROW"; }
        else { bShoot.innerText=p.hasBall?"SHOOT":"SLIDE"; bPass.innerText="PASS"; }
      } else {
        spd *= 0.85;
        if (p.pos === 'GK') {
          const goalZ = p.team==='p1'?CFG.fieldL/2 : -CFG.fieldL/2;
          let targetX = ball.mesh.position.x * 0.5;
          dir.set(targetX - p.mesh.position.x, 0, goalZ - p.mesh.position.z - (p.team==='p1'?2:-2));
        } else {
          if (ball.owner && ball.owner.team !== p.team) dir.copy(ball.mesh.position).sub(p.mesh.position);
          else { let t = p.homePos.clone(); t.z += ball.mesh.position.z*0.5; dir.copy(t).sub(p.mesh.position); }
        }
      }

      if (dir.lengthSq() > 0.1) {
        dir.normalize();
        p.velocity.lerp(dir.multiplyScalar(spd), dt*5);
        p.mesh.lookAt(p.mesh.position.clone().add(dir));

        // Animation: run when moving
        const mx = humanoidMixerById.get(p);
        if (mx && p.__run && p.__idle) {
          if (!p.__run.isRunning()) { p.__idle.stop(); p.__run.reset().play(); }
        }
      } else {
        p.velocity.lerp(new THREE.Vector3(), dt*5);

        // Animation: idle when still
        const mx = humanoidMixerById.get(p);
        if (mx && p.__run && p.__idle) {
          if (p.__run.isRunning()) { p.__run.stop(); p.__idle.reset().play(); }
        }
      }
      p.mesh.position.add(p.velocity.clone().multiplyScalar(dt));

      // Update mixers
      const mx2 = humanoidMixerById.get(p);
      if (mx2) mx2.update(dt);

      if (!ball.owner && p.cooldown<=0 && p.mesh.position.distanceTo(ball.mesh.position) < 1.5) {
        ball.owner = p; p.hasBall = true;
      }
    });

    const target = ball.owner ? ball.owner.mesh.position : ball.mesh.position;
    camera.position.lerp(new THREE.Vector3(0, 60, target.z + 50), 0.1);
    camera.lookAt(target.x*0.1, 0, target.z);
  }

  renderer.render(scene, camera);
}

function setupInputs() {
  const zone = document.getElementById('joy-zone');
  const stick = document.getElementById('joy-stick');
  let startX=0, startY=0;

  const moveStick = (cx, cy) => {
    let dx = cx - startX, dy = cy - startY;
    const d = Math.sqrt(dx*dx+dy*dy);
    if (d>40) { const r=40/d; dx*=r; dy*=r; }
    stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    input.x = dx/40; input.y = dy/40;
  };

  zone.addEventListener('touchstart', e=>{ e.preventDefault(); input.active=true; const r=zone.getBoundingClientRect(); startX=r.left+70; startY=r.top+70; moveStick(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
  zone.addEventListener('touchmove', e=>{ e.preventDefault(); moveStick(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
  zone.addEventListener('touchend', ()=>{ input.active=false; input.x=0; input.y=0; stick.style.transform=`translate(-50%,-50%)`; });

  zone.addEventListener('mousedown', e=>{ input.active=true; const r=zone.getBoundingClientRect(); startX=r.left+70; startY=r.top+70; moveStick(e.clientX, e.clientY); });
  window.addEventListener('mousemove', e=>{ if(input.active) moveStick(e.clientX, e.clientY); });
  window.addEventListener('mouseup', ()=>{ input.active=false; input.x=0; input.y=0; stick.style.transform=`translate(-50%,-50%)`; });

  const doAction = (type) => {
    if(!gameActive || isPaused) return;
    const p = players.find(pl => pl.role === 'human');
    if(!p) return;

    if(type === 'shoot') {
      if(p.hasBall) {
        p.hasBall=false; ball.owner=null; p.cooldown=0.5;
        const dir = new THREE.Vector3(0,0,p.team==='p1'?-1:1).applyAxisAngle(new THREE.Vector3(0,1,0), p.mesh.rotation.y);
        const pwr = p.pos==='GK'?50:40; const lift = p.pos==='GK'?20:6;
        ball.velocity.copy(dir.multiplyScalar(pwr)); ball.velocity.y = lift;
      }
    }
    if(type === 'pass' && p.hasBall) {
      p.hasBall=false; ball.owner=null; p.cooldown=0.5;
      const dir = new THREE.Vector3(0,0,p.team==='p1'?-1:1).applyAxisAngle(new THREE.Vector3(0,1,0), p.mesh.rotation.y);
      ball.velocity.copy(dir.multiplyScalar(25)); ball.velocity.y = p.pos==='GK'?8:1;
    }
  };

  document.getElementById('b-shoot').addEventListener('touchstart', (e)=>{e.preventDefault(); doAction('shoot')}, {passive:false});
  document.getElementById('b-pass').addEventListener('touchstart', (e)=>{e.preventDefault(); doAction('pass')}, {passive:false});
  document.getElementById('b-sprint').addEventListener('touchstart', (e)=>{e.preventDefault(); input.sprint=true}, {passive:false});
  document.getElementById('b-sprint').addEventListener('touchend', (e)=>{e.preventDefault(); input.sprint=false}, {passive:false});

  document.getElementById('b-shoot').addEventListener('mousedown', ()=>doAction('shoot'));
  document.getElementById('b-pass').addEventListener('mousedown', ()=>doAction('pass'));
  document.getElementById('b-sprint').addEventListener('mousedown', ()=>input.sprint=true);
  document.getElementById('b-sprint').addEventListener('mouseup', ()=>input.sprint=false);

  window.addEventListener('keydown', e => {
    if(e.code==='Space') doAction('shoot');
    if(e.key==='z') doAction('pass');
    if(e.key==='Shift') input.sprint=true;
    if(['w','ArrowUp'].includes(e.key)) { input.active=true; input.y=-1; }
    if(['s','ArrowDown'].includes(e.key)) { input.active=true; input.y=1; }
    if(['a','ArrowLeft'].includes(e.key)) { input.active=true; input.x=-1; }
    if(['d','ArrowRight'].includes(e.key)) { input.active=true; input.x=1; }
  });
  window.addEventListener('keyup', e => {
    if(e.key==='Shift') input.sprint=false;
    if(['w','s','ArrowUp','ArrowDown'].includes(e.key)) input.y=0;
    if(['a','d','ArrowLeft','ArrowRight'].includes(e.key)) input.x=0;
    if(input.x===0 && input.y===0) input.active=false;
  });
}

function onResize() {
  if(renderer && camera) {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
}

window.onload = () => {
  document.getElementById('debug-status').innerText = "System Ready";
  showScreen('title-screen');
};
</script>

</body>
</html>
